# rc.txt file for leash with firmwares containing e725dee001353d96c3b08c503037500282d026c4

# sercon
# Start console on USB
# nshterm /dev/ttyACM0 &

uorb start
usleep 1000000

set PARAM_FILE /fs/microsd/params
if mtd start
then
	set PARAM_FILE /fs/mtd_params
fi

param select $PARAM_FILE
if param load
then
	echo "[init] Parameters loaded: $PARAM_FILE"
else
	echo "[init] ERROR: Parameters loading failed: $PARAM_FILE"
fi


 sh /etc/init.d/rc.sensors
 usleep 1000000
 # Original gps
 gps start
 # Fake gps
 # gps start -f
 usleep 1000000

 attitude_estimator_ekf start
 usleep 1000000
 position_estimator_inav start
 usleep 1000000

#
# Start system state indicator
#
if rgbled start
then
	echo "[init] Using external RGB Led"
else
	if blinkm start
	then
		echo "[init] Using blinkm"
		blinkm systemstate
	fi
fi

commander start
usleep 1000000
fmu mode_gpio
usleep 1000000
airdog start
usleep 1000000

 # Targeter+trajectory USB-test Mavlink
 # mavlink start -r 20000 -d /dev/ttyACM0 -m target

#
# MAVLink
#
if param compare AIRD_LEASH_MODE 0
then
	#Default leash
	mavlink start -d $MAVLINK_TTY -m custom
	usleep 1000
	mavlink stream -r 18 -d $MAVLINK_TTY -s GLOBAL_POSITION_INT
	usleep 1000
	mavlink stream -r 0.1 -d $MAVLINK_TTY -s GPS_RAW_INT
else
	if param compare AIRD_LEASH_MODE 1
	then
		#Trainer leash
		mavlink start -d $MAVLINK_TTY -m custom
	else
		if param compare AIRD_LEASH_MODE 2
		then
			#Follow path leash
			trajectory_calculator start
			mavlink start -d $MAVLINK_TTY -m target
			usleep 1000
			mavlink stream -r 0.1 -d $MAVLINK_TTY -s GPS_RAW_INT
		fi
	fi
fi

if param compare SDLOG_ON_BOOT 1
then
	sdlog2 start -r 200 -e -b 22
else
	sdlog2 start -r 200 -b 22 -t
fi
#exit
